<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://unpkg.com/preact@10.27.2/dist/preact.umd.js"></script>
    <script src="https://unpkg.com/preact@10.27.2/hooks/dist/hooks.umd.js"></script>
    <script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
    <script>
      function handleEscape(event) {
        if (event.key === "Escape") {
          const mainImage = document.getElementById("main-image");
          mainImage.style.display = "none";
        }
      }

      function displayImage(src) {
        const mainImage = document.getElementById("main-image");
        mainImage.src = src;
        mainImage.style.display = "block";
        mainImage.onclick = () => {
          mainImage.style.display = "none";
        };
      }

      function deleteImage(item) {
        console.log("Deleting item:", item);
        if (confirm(`Are you sure you want to delete ${item.original_name}?`)) {
          fetch(`/delete/${item.relative_base_path}${item.original_name}`)
            .then((data) => {
              console.log(data);
            })
            .catch((error) => {
              console.error("Error resyncing:", error);
            });
        }
      }

      function deleteImages(thumbnails) {
        const toDelete = thumbnails
          .filter((t) => {
            return t.selected;
          })
          .map((t) => t.relative_base_path + t.original_name);

        if (
          confirm(`Are you sure you want to delete ${toDelete.length} files?`)
        ) {
          fetch("/delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(toDelete),
          })
            .then((result) => {
              console.log("Delete result", result);
            })
            .catch((error) => {
              console.error("Error during deleting:", error);
            });
        }
      }

      function resync(baseDir) {
        console.log("Resyncing directory:", baseDir);
        fetch(`/sync/${baseDir}`)
          .then((data) => {
            console.log(data);
          })
          .catch((error) => {
            console.error("Error resyncing:", error);
          });
      }

      function parentPath(baseDir) {
        var p = baseDir.split("/");

        p.pop();
        p.pop();

        return p.join("/");
      }

      function bytesToKB(bytes) {
        return (bytes / 1024).toFixed(2) + " KB";
      }

      function App() {
        const [thumbnails, setThumbnails] = preactHooks.useState([]);
        const [totalSize, setTotalSize] = preactHooks.useState(0);
        const [count, setCount] = preactHooks.useState(0);
        const [baseDir, setBaseDir] = preactHooks.useState("");
        const [currentIndex, setCurrentIndex] = preactHooks.useState(-1);

        preactHooks.useEffect(() => {
          fetch("bundles.json")
            .then((response) => response.json())
            .then((data) => {
              setThumbnails(data);
              setCount(data.length);
              setTotalSize(data.reduce((acc, e) => acc + e.file_size, 0));
            })
            .catch((error) => {
              console.error("Error fetching bundles:", error);
            });
        }, []);

        // keyboard handlers for navigation and selection
        preactHooks.useEffect(() => {
          function handleKey(e) {
            if (e.key === "ArrowLeft") {
              prev();
            } else if (e.key === "ArrowRight") {
              next();
            } else if (e.key === "s" || e.key === "S") {
              toggleSelectAtIndex(currentIndex);
            } else if (e.key === "Escape") {
              setCurrentIndex(-1);
            }
          }

          window.addEventListener("keydown", handleKey);
          return () => window.removeEventListener("keydown", handleKey);
        }, [currentIndex, thumbnails]);

        const parent = parentPath(baseDir);

        function openImage(index) {
          if (!thumbnails || thumbnails.length === 0) return;
          if (index < 0 || index >= thumbnails.length) return;
          setCurrentIndex(index);
        }

        function prev() {
          if (!thumbnails || thumbnails.length === 0) return;
          const newIndex =
            currentIndex <= 0 ? thumbnails.length - 1 : currentIndex - 1;
          setCurrentIndex(newIndex);
        }

        function next() {
          if (!thumbnails || thumbnails.length === 0) return;
          const newIndex =
            currentIndex === -1 || currentIndex >= thumbnails.length - 1
              ? 0
              : currentIndex + 1;
          setCurrentIndex(newIndex);
        }

        function toggleSelectAtIndex(index) {
          if (index < 0 || index >= thumbnails.length) return;
          const newThumbnails = thumbnails.map((t, i) =>
            i === index ? { ...t, selected: !t.selected } : t,
          );
          setThumbnails(newThumbnails);
        }

        // if currentIndex >= 0 show the corresponding full image
        const mainSrc =
          currentIndex >= 0 && thumbnails[currentIndex]
            ? thumbnails[currentIndex].original_name
            : null;

        directoryInfo = preact.h(
          "div",
          { style: { marginBottom: "20px" } },
          preact.h("h2", null, "Image Gallery"),
          preact.h("p", null, `Total Size: ${bytesToKB(totalSize)} (${count})`),
          preact.h(
            "p",
            null,
            "Click on a thumbnail to view the full image. Click on the full image to close it.",
          ),
          preact.h("button", { onclick: () => resync(baseDir) }, "Resync"),
          preact.h(
            "button",
            { onclick: () => deleteImages(thumbnails) },
            "Delete selected",
          ),
          preact.h("a", { href: `/serve/${parent}/` }, "Parent directory"),
          preact.h(
            "p",
            null,
            "Keyboard: ← Previous, → Next, S Select/Deselect, Esc Close",
          ),
          // Prev/Next buttons
          preact.h(
            "div",
            null,
            preact.h(
              "button",
              { onclick: prev, style: { marginRight: "8px" } },
              "Prev",
            ),
            preact.h("button", { onclick: next }, "Next"),
          ),
        );

        // Create thumbnails
        const thumbnailChildren = thumbnails.map((item, index) => {
          return preact.h(Thumbnail, {
            key: index,
            thumbnail_name: item.thumbnail_name,
            item: item,
            selected: item.selected,
            focused: index === currentIndex,
            onOpen: () => openImage(index),
            onToggleSelect: () => toggleSelectAtIndex(index),
          });
        });

        thumbnailPanel = preact.h(
          "div",
          { id: "thumbnails" },
          thumbnailChildren,
        );

        mainImage = preact.h(
          "img",
          {
            id: "main-image",
            src: mainSrc || "",
            style: {
              display: mainSrc ? "block" : "none",
              position: "fixed",
              top: "50%",
              left: "50%",
              transform: "translate(-50%, -50%)",
              maxWidth: "95vw",
              maxHeight: "95vh",
              zIndex: "1000",
              cursor: "pointer",
            },
            onclick: () => setCurrentIndex(-1),
          },
          null,
        );

        return preact.h(
          "div",
          { id: "container" },
          directoryInfo,
          thumbnailPanel,
          mainImage,
        );
      }

      function Thumbnail(props) {
        // local state removed; use props.item.selected instead
        const selected = props.selected;
        const focused = props.focused;

        thumbnailImage = preact.h("div", {
          className: "thumbnail",
          style: {
            backgroundImage: `url(${props.item.thumbnail_name})`,
            backgroundPosition: `-${props.item.position_x}px 0px`,
            backgroundRepeat: "no-repeat",
            minWidth: `${props.item.width}px`,
            height: `${props.item.height}px`,
            display: "inline-block",
          },
          onclick: () => props.onOpen(),
        });

        thumbnailBox = preact.h(
          "div",
          {
            style: {
              display: "inline-block",
              textAlign: "center",
              fontSize: "12px",
              marginBottom: "10px",
              backgroundColor: selected ? "#dd8c8c" : "",
              border: focused ? "2px solid #2b7be9" : "1px solid #ccc",
              padding: "4px",
            },
          },
          thumbnailImage,
          preact.h("div", null, props.item.original_name.slice(-10)),
          preact.h("div", null, `${bytesToKB(props.item.file_size)}`),
          preact.h(
            "div",
            {
              style: { cursor: "pointer" },
              onclick: (e) => {
                // stop click bubbling so opening image doesn't happen
                e.stopPropagation();
                props.onToggleSelect();
              },
            },
            selected ? "Deselect" : "Select",
          ),
        );

        return thumbnailBox;
      }

      document.addEventListener("DOMContentLoaded", function () {
        preact.render(preact.h(App, null), document.body);
      });
    </script>
    <style type="text/css">
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f4f4f4;
      }
      #container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      #thumbnails {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .thumbnail {
        width: 150px;
        height: 150px;
        background-size: cover;
        background-position: center;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body></body>
</html>
